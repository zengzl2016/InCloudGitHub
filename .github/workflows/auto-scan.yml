name: AI API Key Scanner - Auto Scan

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ - æ¯å¤© UTC æ—¶é—´ 02:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©æ‰§è¡Œä¸€æ¬¡
    # - cron: '0 */12 * * *'  # æ¯12å°æ—¶æ‰§è¡Œä¸€æ¬¡
    # - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥æ‰§è¡Œä¸€æ¬¡
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      scan_mode:
        description: 'æ‰«ææ¨¡å¼'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - user
          - org
      target:
        description: 'æ‰«æç›®æ ‡ï¼ˆç”¨æˆ·åæˆ–ç»„ç»‡åï¼Œautoæ¨¡å¼æ—¶å¯ç•™ç©ºï¼‰'
        required: false
        type: string
      max_repos:
        description: 'æœ€å¤§æ‰«æä»“åº“æ•°'
        required: false
        default: '50'
        type: string

# ä»»åŠ¡å®šä¹‰
jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
      - name: âš™ï¸ é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "GITHUB_TOKEN=${{ secrets.GH_SCAN_TOKEN }}" > .env
          echo "OUTPUT_DIR=./scan_reports" >> .env
      
      # 5. æ‰§è¡Œæ‰«æï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
      - name: ğŸ” æ‰§è¡Œè‡ªåŠ¨æ‰«æ
        if: github.event_name == 'schedule'
        run: |
          python scan_github.py --auto --max-repos 50
      
      # 6. æ‰§è¡Œæ‰«æï¼ˆæ‰‹åŠ¨è§¦å‘ - autoæ¨¡å¼ï¼‰
      - name: ğŸ” æ‰§è¡Œæ‰«æ (auto)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.scan_mode == 'auto'
        run: |
          python scan_github.py --auto --max-repos ${{ github.event.inputs.max_repos }}
      
      # 7. æ‰§è¡Œæ‰«æï¼ˆæ‰‹åŠ¨è§¦å‘ - useræ¨¡å¼ï¼‰
      - name: ğŸ” æ‰§è¡Œæ‰«æ (user)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.scan_mode == 'user'
        run: |
          python scan_github.py --user ${{ github.event.inputs.target }}
      
      # 8. æ‰§è¡Œæ‰«æï¼ˆæ‰‹åŠ¨è§¦å‘ - orgæ¨¡å¼ï¼‰
      - name: ğŸ” æ‰§è¡Œæ‰«æ (org)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.scan_mode == 'org'
        run: |
          python scan_github.py --org ${{ github.event.inputs.target }}
      
      # 9. ä¸Šä¼ æ‰«ææŠ¥å‘Š
      - name: ğŸ“¤ ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-report-${{ github.run_number }}
          path: scan_reports/
          retention-days: 90
          if-no-files-found: ignore
      
      # 10. æäº¤æ‰«æå†å²å’ŒæŠ¥å‘Š
      - name: ğŸ’¾ æäº¤æ‰«æå†å²å’ŒæŠ¥å‘Š
        if: always()
        run: |
          git config user.name "gaocaipeng"
          git config user.email "2540225402@qq.com"
          
          # æ·»åŠ æ‰«æå†å²
          git add scan_history/
          
          # æ·»åŠ æ‰«ææŠ¥å‘Š
          if [ -d "scan_reports" ] && [ "$(ls -A scan_reports 2>/dev/null)" ]; then
            git add scan_reports/
            echo "âœ… å‘ç°æ‰«ææŠ¥å‘Šï¼Œå°†ä¸€å¹¶æäº¤"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ‰«æå†å²æˆ–æŠ¥å‘Š"
          else
            # ç»Ÿè®¡ä¿¡æ¯
            HISTORY_CHANGED=$(git diff --cached --name-only | grep "scan_history/" | wc -l | tr -d ' ')
            REPORTS_CHANGED=$(git diff --cached --name-only | grep "scan_reports/" | wc -l | tr -d ' ')
            
            # æäº¤æ¶ˆæ¯
            COMMIT_MSG="ğŸ“ æ›´æ–°æ‰«ææ•°æ® [skip ci]"
            if [ "$HISTORY_CHANGED" -gt 0 ] && [ "$REPORTS_CHANGED" -gt 0 ]; then
              COMMIT_MSG="ğŸ“ æ›´æ–°æ‰«æå†å²å’ŒæŠ¥å‘Š [skip ci]"
            elif [ "$REPORTS_CHANGED" -gt 0 ]; then
              COMMIT_MSG="ğŸ“„ æ·»åŠ æ‰«ææŠ¥å‘Š [skip ci]"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… å·²æäº¤: å†å²æ–‡ä»¶ $HISTORY_CHANGED ä¸ª, æŠ¥å‘Šæ–‡ä»¶ $REPORTS_CHANGED ä¸ª"
          fi
      
      # 11. æ˜¾ç¤ºæŠ¥å‘Šæ‘˜è¦
      - name: ğŸ“Š æ˜¾ç¤ºæ‰«ææ‘˜è¦
        if: always()
        run: |
          if [ -d "scan_reports" ] && [ "$(ls -A scan_reports)" ]; then
            echo "## ğŸ“‹ æ‰«ææŠ¥å‘Šç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ æŠ¥å‘Šæ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
            ls -lh scan_reports/ >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“„ æŠ¥å‘Šé¢„è§ˆï¼ˆå‰50è¡Œï¼‰:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 50 scan_reports/*.txt | tail -n 50 >> $GITHUB_STEP_SUMMARY || echo "æ— æ³•è¯»å–æŠ¥å‘Šå†…å®¹" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æœªç”ŸæˆæŠ¥å‘Šæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi
      
      # 11. å¯é€‰ï¼šå‘é€é€šçŸ¥ï¼ˆå¦‚æœå‘ç°é—®é¢˜ï¼‰
      - name: ğŸ”” æ£€æŸ¥æ˜¯å¦å‘ç°é—®é¢˜
        id: check_findings
        run: |
          if grep -q "å‘ç°çš„é—®é¢˜æ€»æ•°: [1-9]" scan_reports/*.txt 2>/dev/null; then
            echo "æœ‰å‘ç°é—®é¢˜"
            echo "has_findings=true" >> $GITHUB_OUTPUT
          else
            echo "æœªå‘ç°é—®é¢˜"
            echo "has_findings=false" >> $GITHUB_OUTPUT
          fi
      
      # 12. å¯é€‰ï¼šåˆ›å»º Issueï¼ˆå¦‚æœå‘ç°é«˜å±é—®é¢˜ï¼‰
      - name: ğŸ“¢ åˆ›å»ºå‘Šè­¦ Issue
        if: steps.check_findings.outputs.has_findings == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('scan_reports');
            if (reportFiles.length > 0) {
              const reportContent = fs.readFileSync(`scan_reports/${reportFiles[0]}`, 'utf8');
              const lines = reportContent.split('\n').slice(0, 100).join('\n');
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âš ï¸ å®‰å…¨æ‰«æå‘ç°æ½œåœ¨å¯†é’¥æ³„éœ² - ${new Date().toISOString().split('T')[0]}`,
                body: `# ğŸ” è‡ªåŠ¨æ‰«ææŠ¥å‘Š\n\næœ¬æ¬¡æ‰«æå‘ç°æ½œåœ¨çš„ API å¯†é’¥æ³„éœ²é—®é¢˜ã€‚\n\n**æ‰«ææ—¶é—´**: ${new Date().toISOString()}\n**è¿è¡ŒID**: #${context.runNumber}\n\n## ğŸ“„ æŠ¥å‘Šæ‘˜è¦\n\n\`\`\`\n${lines}\n\`\`\`\n\nå®Œæ•´æŠ¥å‘Šè¯·æŸ¥çœ‹ [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['security', 'auto-scan']
              });
            }

