name: AI API Key Scanner - Manual Scan

# ä»…æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'æ‰«æç±»å‹'
        required: true
        type: choice
        options:
          - 'auto - è‡ªåŠ¨æœç´¢AIé¡¹ç›®'
          - 'user - æ‰«ææŒ‡å®šç”¨æˆ·'
          - 'org - æ‰«ææŒ‡å®šç»„ç»‡'
          - 'repo - æ‰«æå•ä¸ªä»“åº“'
      
      target:
        description: 'æ‰«æç›®æ ‡ï¼ˆç”¨æˆ·å/ç»„ç»‡å/ä»“åº“å…¨åï¼Œautoæ¨¡å¼æ—¶å¯ç•™ç©ºï¼‰'
        required: false
        type: string
        default: ''
      
      max_repos:
        description: 'æœ€å¤§æ‰«æä»“åº“æ•°ï¼ˆä»…autoæ¨¡å¼æœ‰æ•ˆï¼‰'
        required: false
        type: number
        default: 50
      
      create_issue:
        description: 'å‘ç°é—®é¢˜æ—¶æ˜¯å¦åˆ›å»ºIssue'
        required: false
        type: boolean
        default: true

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸æäº¤ä»£ç 
  issues: write    # å…è®¸åˆ›å»º Issue

jobs:
  manual-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: âš™ï¸ é…ç½®ç¯å¢ƒ
        run: |
          echo "GITHUB_TOKEN=${{ secrets.GH_SCAN_TOKEN }}" > .env
          echo "OUTPUT_DIR=./scan_reports" >> .env
          mkdir -p scan_reports
      
      - name: ğŸ” æ‰§è¡Œæ‰«æ - Autoæ¨¡å¼
        if: startsWith(github.event.inputs.scan_type, 'auto')
        run: |
          echo "æ‰§è¡Œè‡ªåŠ¨æ‰«æï¼Œæœ€å¤šæ‰«æ ${{ github.event.inputs.max_repos }} ä¸ªä»“åº“"
          python scan_github.py --auto --max-repos ${{ github.event.inputs.max_repos }}
      
      - name: ğŸ” æ‰§è¡Œæ‰«æ - Useræ¨¡å¼
        if: startsWith(github.event.inputs.scan_type, 'user')
        run: |
          echo "æ‰«æç”¨æˆ·: ${{ github.event.inputs.target }}"
          python scan_github.py --user "${{ github.event.inputs.target }}"
      
      - name: ğŸ” æ‰§è¡Œæ‰«æ - Orgæ¨¡å¼
        if: startsWith(github.event.inputs.scan_type, 'org')
        run: |
          echo "æ‰«æç»„ç»‡: ${{ github.event.inputs.target }}"
          python scan_github.py --org "${{ github.event.inputs.target }}"
      
      - name: ğŸ” æ‰§è¡Œæ‰«æ - Repoæ¨¡å¼
        if: startsWith(github.event.inputs.scan_type, 'repo')
        run: |
          echo "æ‰«æä»“åº“: ${{ github.event.inputs.target }}"
          python scan_github.py --repo "${{ github.event.inputs.target }}"
      
      - name: ğŸ“Š ç”Ÿæˆæ‰«ææ‘˜è¦
        if: always()
        run: |
          echo "# ğŸ” æ‰«æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«æç±»å‹**: ${{ github.event.inputs.scan_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«æç›®æ ‡**: ${{ github.event.inputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f scan_reports/*.txt ]; then
            echo "## ğŸ“„ æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 80 scan_reports/*.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manual-scan-report-${{ github.run_number }}
          path: scan_reports/
          retention-days: 90
          if-no-files-found: ignore
      
      - name: ğŸ’¾ æäº¤æ‰«æå†å²å’ŒæŠ¥å‘Š
        if: always()
        run: |
          git config user.name "gaocaipeng"
          git config user.email "2540225402@qq.com"
          
          # æ·»åŠ æ‰«æå†å²
          git add scan_history/
          
          # æ·»åŠ æ‰«ææŠ¥å‘Š
          if [ -d "scan_reports" ] && [ "$(ls -A scan_reports 2>/dev/null)" ]; then
            git add scan_reports/
            echo "âœ… å‘ç°æ‰«ææŠ¥å‘Šï¼Œå°†ä¸€å¹¶æäº¤"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ‰«æå†å²æˆ–æŠ¥å‘Š"
          else
            # ç»Ÿè®¡ä¿¡æ¯
            HISTORY_CHANGED=$(git diff --cached --name-only | grep "scan_history/" | wc -l | tr -d ' ')
            REPORTS_CHANGED=$(git diff --cached --name-only | grep "scan_reports/" | wc -l | tr -d ' ')
            
            # æäº¤æ¶ˆæ¯
            COMMIT_MSG="ğŸ“ æ›´æ–°æ‰«ææ•°æ® [skip ci]"
            if [ "$HISTORY_CHANGED" -gt 0 ] && [ "$REPORTS_CHANGED" -gt 0 ]; then
              COMMIT_MSG="ğŸ“ æ›´æ–°æ‰«æå†å²å’ŒæŠ¥å‘Š [skip ci]"
            elif [ "$REPORTS_CHANGED" -gt 0 ]; then
              COMMIT_MSG="ğŸ“„ æ·»åŠ æ‰«ææŠ¥å‘Š [skip ci]"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… å·²æäº¤: å†å²æ–‡ä»¶ $HISTORY_CHANGED ä¸ª, æŠ¥å‘Šæ–‡ä»¶ $REPORTS_CHANGED ä¸ª"
          fi
      
      - name: ğŸ”” åˆ†æç»“æœ
        id: analyze
        if: always()
        run: |
          if [ -f scan_reports/*.txt ]; then
            FINDINGS=$(grep "å‘ç°çš„é—®é¢˜æ€»æ•°:" scan_reports/*.txt | grep -oE '[0-9]+' || echo "0")
            echo "å‘ç° $FINDINGS ä¸ªæ½œåœ¨é—®é¢˜"
            echo "findings_count=$FINDINGS" >> $GITHUB_OUTPUT
            
            if [ "$FINDINGS" -gt 0 ]; then
              echo "has_findings=true" >> $GITHUB_OUTPUT
            else
              echo "has_findings=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "findings_count=0" >> $GITHUB_OUTPUT
            echo "has_findings=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¢ åˆ›å»ºå‘Šè­¦Issue
        if: |
          always() && 
          github.event.inputs.create_issue == 'true' && 
          steps.analyze.outputs.has_findings == 'true'
        uses: actions/github-script@v7
        env:
          FINDINGS_COUNT: ${{ steps.analyze.outputs.findings_count }}
          SCAN_TYPE: ${{ github.event.inputs.scan_type }}
          SCAN_TARGET: ${{ github.event.inputs.target }}
        with:
          script: |
            const fs = require('fs');
            const reportDir = 'scan_reports';
            const findingsCount = process.env.FINDINGS_COUNT;
            const scanType = process.env.SCAN_TYPE;
            const scanTarget = process.env.SCAN_TARGET;
            
            if (fs.existsSync(reportDir)) {
              const files = fs.readdirSync(reportDir);
              if (files.length > 0) {
                const reportPath = `${reportDir}/${files[0]}`;
                const content = fs.readFileSync(reportPath, 'utf8');
                const preview = content.split('\n').slice(0, 120).join('\n');
                
                const issueTitle = `ğŸš¨ [æ‰‹åŠ¨æ‰«æ] å‘ç° ${findingsCount} ä¸ªæ½œåœ¨å¯†é’¥æ³„éœ²`;
                const issueBody = [
                  '# ğŸ” æ‰‹åŠ¨æ‰«ææŠ¥å‘Š',
                  '',
                  '## æ‰«æä¿¡æ¯',
                  '',
                  `- æ‰«æç±»å‹: ${scanType}`,
                  `- æ‰«æç›®æ ‡: ${scanTarget}`,
                  `- æ‰§è¡Œæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`,
                  `- å‘ç°é—®é¢˜æ•°: ${findingsCount}`,
                  `- Workflow Run: [#${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  '',
                  '## ğŸ“„ æŠ¥å‘Šé¢„è§ˆ',
                  '',
                  '```',
                  preview,
                  '```',
                  '',
                  '## ğŸ”— å®Œæ•´æŠ¥å‘Š',
                  '',
                  `è¯·ä» [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) ä¸‹è½½å®Œæ•´æŠ¥å‘Šã€‚`,
                  '',
                  '## âš ï¸ å»ºè®®æ“ä½œ',
                  '',
                  '1. ç«‹å³æ£€æŸ¥æŠ¥å‘Šä¸­æ ‡è®°çš„é«˜ç½®ä¿¡åº¦é—®é¢˜',
                  '2. è½®æ¢æ‰€æœ‰æ³„éœ²çš„ API å¯†é’¥',
                  '3. ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡',
                  '4. æ›´æ–° .gitignore é˜²æ­¢æœªæ¥æ³„éœ²',
                  '',
                  '---',
                  '*æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*'
                ].join('\n');
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['security', 'manual-scan', 'needs-review']
                });
              }
            }

