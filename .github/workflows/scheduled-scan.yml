name: AI API Key Scanner - Scheduled Scan

# å¤šç§å®šæ—¶è§¦å‘é€‰é¡¹
on:
  schedule:
    # æ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * *'
    
    # ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–æ—¶é—´ï¼Œå–æ¶ˆæ³¨é‡Šå³å¯ï¼š
    # - cron: '0 */6 * * *'    # æ¯6å°æ—¶ä¸€æ¬¡
    # - cron: '0 0,12 * * *'   # æ¯å¤© 00:00 å’Œ 12:00
    # - cron: '0 2 * * 1'      # æ¯å‘¨ä¸€ 02:00
    # - cron: '0 2 1 * *'      # æ¯æœˆ1å· 02:00
  
  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ - åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªæ‰«æä»»åŠ¡
concurrency:
  group: scheduled-scan
  cancel-in-progress: false

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: read
  issues: write  # å…è®¸åˆ›å»ºå’Œæ›´æ–° Issue

jobs:
  scheduled-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è¶…æ—¶æ—¶é—´60åˆ†é’Ÿ
    
    steps:
      - name: ğŸ“… æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
        run: |
          echo "ğŸ• å½“å‰æ—¶é—´ï¼ˆUTCï¼‰: $(date -u)"
          echo "ğŸ• å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬ï¼‰: $(TZ='Asia/Shanghai' date)"
      
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: âš™ï¸ é…ç½®ç¯å¢ƒ
        env:
          GITHUB_SCAN_TOKEN: ${{ secrets.GH_SCAN_TOKEN }}
        run: |
          echo "GITHUB_TOKEN=${GITHUB_SCAN_TOKEN}" > .env
          echo "OUTPUT_DIR=./scan_reports" >> .env
          mkdir -p scan_reports
      
      - name: ğŸ” æ‰§è¡Œå®šæ—¶æ‰«æ
        id: scan
        run: |
          echo "å¼€å§‹æ‰§è¡Œè‡ªåŠ¨æ‰«æä»»åŠ¡..."
          python scan_github.py --auto --max-repos 50 2>&1 | tee scan.log
          
          # è®°å½•æ‰«æçŠ¶æ€
          if [ $? -eq 0 ]; then
            echo "scan_status=success" >> $GITHUB_OUTPUT
          else
            echo "scan_status=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“Š åˆ†ææ‰«æç»“æœ
        id: analyze
        if: always()
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥å‘Šç”Ÿæˆ
          if [ -d "scan_reports" ] && [ "$(ls -A scan_reports)" ]; then
            REPORT_FILE=$(ls -t scan_reports/*.txt | head -1)
            
            # æå–å‘ç°çš„é—®é¢˜æ•°
            TOTAL=$(grep "å‘ç°çš„é—®é¢˜æ€»æ•°:" "$REPORT_FILE" | grep -oE '[0-9]+' || echo "0")
            HIGH=$(grep "é«˜ç½®ä¿¡åº¦:" "$REPORT_FILE" | grep -oE '[0-9]+' || echo "0")
            MEDIUM=$(grep "ä¸­ç½®ä¿¡åº¦:" "$REPORT_FILE" | grep -oE '[0-9]+' || echo "0")
            
            echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
            echo "high_confidence=$HIGH" >> $GITHUB_OUTPUT
            echo "medium_confidence=$MEDIUM" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š æ‰«æç»“æœç»Ÿè®¡:"
            echo "  - æ€»é—®é¢˜æ•°: $TOTAL"
            echo "  - é«˜ç½®ä¿¡åº¦: $HIGH"
            echo "  - ä¸­ç½®ä¿¡åº¦: $MEDIUM"
            
            # åˆ¤æ–­æ˜¯å¦éœ€è¦å‘Šè­¦
            if [ "$TOTAL" -gt 0 ]; then
              echo "needs_alert=true" >> $GITHUB_OUTPUT
            else
              echo "needs_alert=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ‰«ææŠ¥å‘Š"
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "needs_alert=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“ ç”Ÿæˆæ‘˜è¦
        if: always()
        run: |
          echo "# ğŸ” å®šæ—¶æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«ææ¨¡å¼**: è‡ªåŠ¨æœç´¢ AI ç›¸å…³é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«æçŠ¶æ€**: ${{ steps.scan.outputs.scan_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f scan_reports/*.txt ]; then
            echo "## ğŸ“Š æ‰«æç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”´ é«˜ç½®ä¿¡åº¦é—®é¢˜: ${{ steps.analyze.outputs.high_confidence }}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŸ¡ ä¸­ç½®ä¿¡åº¦é—®é¢˜: ${{ steps.analyze.outputs.medium_confidence }}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¦ æ€»é—®é¢˜æ•°: ${{ steps.analyze.outputs.total_findings }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## ğŸ“„ æŠ¥å‘Šé¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 100 scan_reports/*.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scheduled-scan-${{ github.run_number }}
          path: |
            scan_reports/
            scan.log
          retention-days: 90
          if-no-files-found: ignore
      
      - name: ğŸ’¾ æäº¤æ‰«æå†å²å’ŒæŠ¥å‘Š
        if: always()
        run: |
          git config user.name "gaocaipeng"
          git config user.email "2540225402@qq.com"
          
          # æ·»åŠ æ‰«æå†å²
          git add scan_history/
          
          # æ·»åŠ æ‰«ææŠ¥å‘Š
          if [ -d "scan_reports" ] && [ "$(ls -A scan_reports 2>/dev/null)" ]; then
            git add scan_reports/
            echo "âœ… å‘ç°æ‰«ææŠ¥å‘Šï¼Œå°†ä¸€å¹¶æäº¤"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ‰«æå†å²æˆ–æŠ¥å‘Š"
          else
            # ç»Ÿè®¡ä¿¡æ¯
            HISTORY_CHANGED=$(git diff --cached --name-only | grep "scan_history/" | wc -l | tr -d ' ')
            REPORTS_CHANGED=$(git diff --cached --name-only | grep "scan_reports/" | wc -l | tr -d ' ')
            
            # æäº¤æ¶ˆæ¯
            COMMIT_MSG="ğŸ“ æ›´æ–°æ‰«ææ•°æ® [skip ci]"
            if [ "$HISTORY_CHANGED" -gt 0 ] && [ "$REPORTS_CHANGED" -gt 0 ]; then
              COMMIT_MSG="ğŸ“ æ›´æ–°æ‰«æå†å²å’ŒæŠ¥å‘Š [skip ci]"
            elif [ "$REPORTS_CHANGED" -gt 0 ]; then
              COMMIT_MSG="ğŸ“„ æ·»åŠ æ‰«ææŠ¥å‘Š [skip ci]"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… å·²æäº¤: å†å²æ–‡ä»¶ $HISTORY_CHANGED ä¸ª, æŠ¥å‘Šæ–‡ä»¶ $REPORTS_CHANGED ä¸ª"
          fi
      
      - name: ğŸš¨ åˆ›å»ºå‘Šè­¦Issueï¼ˆå‘ç°é—®é¢˜æ—¶ï¼‰
        if: steps.analyze.outputs.needs_alert == 'true'
        uses: actions/github-script@v7
        env:
          TOTAL_FINDINGS: ${{ steps.analyze.outputs.total_findings }}
          HIGH_CONFIDENCE: ${{ steps.analyze.outputs.high_confidence }}
          MEDIUM_CONFIDENCE: ${{ steps.analyze.outputs.medium_confidence }}
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('scan_reports');
            
            if (reportFiles.length > 0) {
              const reportPath = `scan_reports/${reportFiles[0]}`;
              const content = fs.readFileSync(reportPath, 'utf8');
              const preview = content.split('\n').slice(0, 150).join('\n');
              
              const total = process.env.TOTAL_FINDINGS;
              const high = process.env.HIGH_CONFIDENCE;
              const medium = process.env.MEDIUM_CONFIDENCE;
              
              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šå¤©çš„issue
              const today = new Date().toISOString().split('T')[0];
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'auto-scan,security',
                state: 'open'
              });
              
              const todayIssue = existingIssues.data.find(issue => 
                issue.title.includes(today)
              );
              
              if (todayIssue) {
                // æ›´æ–°ç°æœ‰issue
                const updateBody = [
                  '## ğŸ”„ æ›´æ–°ï¼šæ–°çš„æ‰«æå‘ç°',
                  '',
                  `æ‰«ææ—¶é—´: ${new Date().toLocaleString('zh-CN')}`,
                  `è¿è¡Œ: [#${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  '',
                  '### ğŸ“Š æœ¬æ¬¡æ‰«æç»Ÿè®¡',
                  `- ğŸ”´ é«˜ç½®ä¿¡åº¦: ${high}`,
                  `- ğŸŸ¡ ä¸­ç½®ä¿¡åº¦: ${medium}`,
                  `- ğŸ“¦ æ€»è®¡: ${total}`,
                  '',
                  'å®Œæ•´æŠ¥å‘Šè¯·æŸ¥çœ‹ Artifactsã€‚'
                ].join('\n');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: updateBody
                });
              } else {
                // åˆ›å»ºæ–°issue
                const highWarning = high > 0 ? 'âš ï¸ éœ€ç«‹å³å¤„ç†' : '';
                const mediumWarning = medium > 0 ? 'âš ï¸ å»ºè®®å®¡æŸ¥' : '';
                
                const issueTitle = `ğŸš¨ [${today}] å®‰å…¨æ‰«æå‘ç° ${total} ä¸ªæ½œåœ¨å¯†é’¥æ³„éœ²`;
                const issueBody = [
                  '# ğŸ” è‡ªåŠ¨æ‰«æå‘Šè­¦',
                  '',
                  '## ğŸ“‹ æ‰«æä¿¡æ¯',
                  '',
                  `- æ‰«ææ—¥æœŸ: ${today}`,
                  `- æ‰§è¡Œæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`,
                  `- Workflow: [Run #${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  '',
                  '## ğŸ“Š å‘ç°é—®é¢˜ç»Ÿè®¡',
                  '',
                  `- ğŸ”´ é«˜ç½®ä¿¡åº¦: ${high} ä¸ª ${highWarning}`,
                  `- ğŸŸ¡ ä¸­ç½®ä¿¡åº¦: ${medium} ä¸ª ${mediumWarning}`,
                  `- ğŸ“¦ æ€»è®¡: ${total} ä¸ª`,
                  '',
                  '## ğŸ“„ æŠ¥å‘Šé¢„è§ˆ',
                  '',
                  '```',
                  preview,
                  '```',
                  '',
                  '## ğŸ”— å®Œæ•´æŠ¥å‘Š',
                  '',
                  `è¯·ä» [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) ä¸‹è½½å®Œæ•´çš„æ‰«ææŠ¥å‘Šã€‚`,
                  '',
                  '## âš ï¸ å»ºè®®çš„å¤„ç†æ­¥éª¤',
                  '',
                  '1. ç«‹å³å®¡æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰é«˜ç½®ä¿¡åº¦çš„å‘ç°',
                  '2. è½®æ¢å¯†é’¥ï¼šå¯¹äºç¡®è®¤æ³„éœ²çš„å¯†é’¥ï¼Œç«‹å³åœ¨æœåŠ¡å•†å¤„è½®æ¢',
                  '3. æ¸…ç†å†å²ï¼šä½¿ç”¨ git-filter-repo æˆ– BFG æ¸…ç† Git å†å²',
                  '4. é˜²èŒƒæªæ–½ï¼š',
                  '   - ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯',
                  '   - æ›´æ–° .gitignore æ–‡ä»¶',
                  '   - é…ç½® pre-commit hooks',
                  '   - å¯ç”¨ GitHub Secret Scanning',
                  '',
                  '## ğŸ“… åç»­æ‰«æ',
                  '',
                  'ä¸‹æ¬¡è‡ªåŠ¨æ‰«æå°†åœ¨æ˜å¤©åŒä¸€æ—¶é—´æ‰§è¡Œã€‚',
                  '',
                  '---',
                  `*ğŸ¤– æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º - [æŸ¥çœ‹å·¥ä½œæµ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/workflows/scheduled-scan.yml)*`
                ].join('\n');
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['security', 'auto-scan', 'needs-review'],
                  assignees: []
                });
              }
            }
      
      - name: âœ… æ‰«æå®Œæˆ
        if: always()
        run: |
          if [ "${{ steps.analyze.outputs.total_findings }}" -gt 0 ]; then
            echo "âš ï¸ æ‰«æå®Œæˆï¼Œå‘ç° ${{ steps.analyze.outputs.total_findings }} ä¸ªæ½œåœ¨é—®é¢˜"
            echo "è¯·æŸ¥çœ‹ç”Ÿæˆçš„ Issue å’Œ Artifacts ä¸­çš„è¯¦ç»†æŠ¥å‘Š"
          else
            echo "âœ… æ‰«æå®Œæˆï¼Œæœªå‘ç°æ˜æ˜¾é—®é¢˜"
          fi
